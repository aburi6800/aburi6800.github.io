---
layout: post
title:  "X-BASICメモ"
date:   2024-05-27 15:40:00 +0900
categories: x68000 xbasic
---

初版 2024/05/27  
改訂  

-----

<br>

X68000でプログラムを開発する手段はいくつかあるが、ここではそのうち最も簡単に開発できる「X-BASIC」を使うための情報を記載する。  

<br>

## X-BASICの利点

- 標準で付いてくる。  

- 豊富なハードウェア資源を一通り使える関数が用意されている。  

- インタプリタ形式のため、手軽にプログラムの実行確認ができる。  

- エディタでプログラムを書ける。  

- 別売りのCコンパイラに同梱されているBASICコンパイラを使うことで、コマンドシェルから直接実行可能なファイルを作成できる。  

- ユーザー独自で外部関数を作成し、BASICに組み込むことが出来る。

<br>

## X-BASICの制約

- 従来のMicrosoft系BASICとは大きく構文などが違うので、慣れが必要。(C言語をやっていたら入りやすいかも)  

- BASIC環境では行番号がついており、プログラムを作成しにくい。  
	> これについては、行番号なしの形式でプログラムをロード・セーブできる命令が用意されており、この形式だとテキストエディタで編集可能となる。  

- インタプリタであるため、実行速度が遅い。  
	> 特にMSX等と同様に割り込み制御を行う命令がないため、BGスクロールとスプライトの移動、処理ロジックを入れると目に見えて遅くなる。16ビット機とは言え、凝ったものは作れないのが残念。  

- 変数の定義が省略できない。  
	> これは、後にC言語への変換を可能とするための制約となる。  

- 直接メモリにアクセスする手段（従来のPOKE、PEEK、CALLなどの命令）がなく、マシン語を使用できない。  
	> これに対する解消方法としては、処理をユーザー外部関数として別途作成して使うという方法があるが、BASICのシステムとして取り込まれるため、注意が必要である。  
	> また、ユーザー定義関数はアセンブラで作成するには難易度が高く、Cで作成するにしてもCコンパイラが別売りのため、ハードルが高い。  

- 定数、構造体が使えない。  
	> 定数は変数名で便宜的な定義ができるが、構造体が使えないのは惜しいところ。

- 関数定義で、引数の省略や配列が指定できない。
	> 引数の省略が指定できないのはまだ設計で回避できるが、せめて配列は指定できるようにして欲しかった。(Cではポインタ渡しで可能)

<br>

## basic起動時の画面表示文字数を増やす

デフォルトでは画面モード512x512で起動するようになっており、filesの結果などが見にくい。  
`BASIC.CNF`でWIDTHの行を以下の内容に更新することで、768x512の高解像度モードで起動できる。  
```
　...
WIDTH = 96
  ...
```

<br>

## テキストエディタでプログラムを書く場合の制約事項

前述のとおり、BASICプログラムもテキストエディタで書くことが可能であるが、以下の制約がある点に注意する。  

- 「行番号なし」の形式で書くため、行の先頭を数字にすると行番号とみなされ、BASICから`load@`できなくなる。例えば、以下のように書くと「行番号があるファイルです」のエラーがでる。  
	
	```
	dim char c(10)
	c ={
	  10, 20, 30, 40, 50,
	  60, 70, 80, 90, 100
	}
	```
	この場合、以下のように行の先頭を「,」などにし、数字以外になるように修正する。  
	```
	dim char c(10)
	c ={10, 20, 30, 40, 50
	   ,60, 70, 80, 90, 100
	}
	```

	> 行番号を付けて書いても良いが、エディタを使う意味がなくなる。  

- 1行255文字以内とすること。  

- プログラムの途中で空行を入れることはできない。  

- ソースの最後は&H0Aでないとならない。最終行は空行とすること。  

<br>

## 変数の定義について

- 使用する変数は必ず定義が必要。  

- 変数には、グローバル変数とローカル変数の2種類がある。  
	- グローバル変数：関数の外で定義された変数で、プログラム全体からアクセスが可能。  
	- ローカル変数：関数の中で定義された変数で、関数の中でのみアクセス可能。関数の処理が終わると破棄される。  

- 変数はローカル変数→グローバル変数の順に参照され、同名の変数が定義された場合はローカル変数が操作対象になる。そのため、グローバル変数とローカル変数は同名でもエラーにならないが、グローバル変数を明示的に指定する手段がないため、この場合はローカル変数しか操作できなくなる。  
	例）
	```
	100 int x = 10
	110 print update(x)
	120 print x /* 元のxの値は変わらない
	130 end
	140 func update(x;int) /* このxはローカル変数として扱われる
	150   x = 20
	160   print x
	170 endfunc
	```

- マニュアルにもあるが、配列変数はグローバル変数として定義する。  
	> 実際は定義もできるが、関数の引数・戻り値に配列の型を指定できないことと、関数の処理が終了すると定義した配列が破棄されるため、ほとんど意味がない。

<br>

## 関数の定義について

- 関数は以下のように定義する。  
	```
	func [<戻り値の型>] <関数名>(<引数の変数名1>[;<型>], <引数の変数名2>[:<型>], ...)
		<型> <ローカル変数名>
		...
		return(<戻り値>)
	endfunc
	```

- 引数は参照渡しのみ。ただし、グローバル変数は関数内でも操作できる。  
- 省略可能な引数の指定は不可。  
- 引数の変数の型、戻り値の型を省略した場合は、int型として処理される。  

<br>

## 付属のスプライトエディタ(DEFSPTOOL.BAS)について

Human68kシステムディスクの`\etc`ディレクトリには、BASICで書かれたスプライトエディタである`defsptool.bas`が収録されている。  
起動は、コマンドラインから以下を実行する。  
```
A>basic \etc\defsptool.bas
```
または、basicから以下を実行する。  
```
run "\etc\defsptool,bas"
```

- このエディタでは、8x8ドットで512パターン、16x16ドットで128パターンの定義が可能だが、セーブしたデータを加工することでプログラム上ではこれ以上の定義も可能。

- 16x16ドット単位の編集となるが、8x8ドット単位でのパターン番号の対応は、以下の通りとなる。(n=16x16ドット時のパターン番号×4)
```
+-----+-----+
|     |     |
|  n  | n+2 |
|     |     |
+-----+-----+
|     |     |
| n+1 | n+3 |
|     |     |
+-----+-----+
```

- BGパターンとして指定できるのは、0～255までの256パターンのため、上半分を使用すると良い。  
	> 実際は使用するBG面の数により変動する。この場合は自前でパターン番号を指定した定義を行う必要がある。

- 付属のスプライトエディタにはロード機能がないが、起動時にスプライト・パレットを初期化しないため、データが定義された状態で起動すると、その時点のVRAMのPCGエリアの内容が表示され、ロードと同じ扱いになる。  
	> BGデータエリアの部分は表示されない。

- セーブは、行番号付きのBASICプログラムの形式でされる。既に作成したプログラムに組み込むためには、`load`後に`save@`するしかないが、その後`load@`しても配列データが行番号とみなされてしまうため、エラーとなる。  
	この対処として、配列データの先頭に「,」を付ける修正を行うと、`load@`が可能となる。  
	> または、sp_def関数の代わりに配列の内容をファイルに出力するようにし、プログラム側ではファイルから読込み定義するようにする方法もある。  

- なお、全て16.x16ドットの定義(`sp_pat`のパターンサイズ=1)で出力される。256x256ドットの画面モードでは8x8ドットのパターンが必要となるが、`bg_put`する際のパターン番号を考慮してパターンデータを作成することで、そのまま使用可能である。  
